{% extends "base.html" %}
{% block content %}
<h2>Тикет #{{ ticket.id }} — {{ ticket.title }}</h2>
<p>
  <strong>Статус:</strong> {{ ticket.status }} |
  <strong>Приоритет:</strong> {{ ticket.priority }} |
  <strong>Создатель:</strong> {{ ticket.creator.username }} ({{ ticket.creator.email }})
</p>
<p><strong>Описание:</strong></p>
<div class="border p-3 mb-3">{{ ticket.description }}</div>

{% if attachments %}
  <h5>Вложения</h5>
  <ul class="list-group mb-3">
    {% for a in attachments %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ a.original_name }} <small class="text-muted">от {{ a.uploader.username }}</small></span>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('uploaded_file', filename=a.filename) }}">Скачать</a>
      </li>
    {% endfor %}
  </ul>
{% endif %}

{% if current_user.is_authenticated and current_user.role == 'support' %}
  {% if ticket.status == 'open' %}
    <form method="post" action="{{ url_for('take_ticket', ticket_id=ticket.id) }}">
      <button class="btn btn-primary">Взять в работу</button>
    </form>
  {% elif ticket.status == 'in_progress' and ticket.assignee_id == current_user.id %}
    <form method="post" action="{{ url_for('resolve_ticket', ticket_id=ticket.id) }}">
      <button class="btn btn-success">Пометить как выполненный</button>
    </form>
  {% else %}
    <p>Исполнитель: {{ ticket.assignee.username if ticket.assignee else '—' }}</p>
  {% endif %}
{% endif %}

<hr>
<h4>Комментарии</h4>
{% if comments %}
  {% for c in comments %}
    <div class="card mb-2">
      <div class="card-body">
        <h6 class="card-subtitle mb-2 text-muted">{{ c.author.username }} — {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</h6>
        <p class="card-text">{{ c.content }}</p>
        {% if c.attachment %}
          <p>Вложение: <a href="{{ url_for('uploaded_file', filename=c.attachment.filename) }}">{{ c.attachment.original_name }}</a></p>
        {% endif %}
      </div>
    </div>
  {% endfor %}
{% else %}
  <p>Комментариев ещё нет.</p>
{% endif %}

<hr>
<h5>Добавить комментарий</h5>
<form method="post" action="{{ url_for('comment_ticket', ticket_id=ticket.id) }}" enctype="multipart/form-data">
  <div class="mb-3">
    <textarea class="form-control" name="content" rows="3" placeholder="Текст комментария"></textarea>
  </div>
  <div class="mb-3">
    <label class="form-label">Вложение (необязательно)</label>
    <input class="form-control" type="file" name="attachment">
  </div>
  <button class="btn btn-primary" type="submit">Отправить</button>
</form>
{% endblock %}